name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run comprehensive tests
        run: |
          cargo test --all-features --verbose
          cargo test --doc --all-features

      - name: Run linter checks
        run: |
          cargo clippy --all-targets --all-features -- -D warnings
          cargo fmt --all -- --check

      - name: Run security tests
        run: |
          cargo test --features "security_hardened constant_time"
          cargo test --doc --features "security_hardened"

      - name: Run performance benchmarks
        run: |
          cargo bench --no-run --features "simd hardware"

      - name: Generate API documentation
        run: |
          cargo doc --all-features --no-deps
          # Add redirect from root to main crate docs
          echo "<meta http-equiv='refresh' content='0; url=vortex_hash/'>" > target/doc/index.html

      - name: Run security audit preparation
        run: |
          cargo test --features "security_hardened memory_safe"
          # Generate coverage report
          cargo install cargo-tarpaulin
          cargo tarpaulin --ignore-tests --out Xml --skip-clean

      - name: Build release binaries
        run: |
          cargo build --release --features "std simd hardware"
          cargo build --release --no-default-features --features "no-std simd"

      - name: Package source distribution
        run: |
          tar -czf vortex_hash-${{ github.ref_name }}.tar.gz \
            --exclude='target' \
            --exclude='.git' \
            --exclude='*.swp' \
            --exclude='*~' \
            --exclude='.*' \
            --transform 's|^|vortex_hash-${{ github.ref_name }}-source/|' \
            --show-transformed-names \
            .

      - name: Package documentation
        run: |
          tar -czf vortex_hash-docs-${{ github.ref_name }}.tar.gz \
            --transform 's|^target/doc/|vortex_hash-docs-${{ github.ref_name }}/|' \
            target/doc/

      - name: Package examples
        run: |
          mkdir -p release-examples
          cp examples/*.rs release-examples/
          tar -czf vortex_hash-examples-${{ github.ref_name }}.tar.gz \
            --transform 's|^release-examples/|vortex_hash-examples-${{ github.ref_name }}/|' \
            release-examples/

      - name: Create default release notes
        run: |
          cat > release-notes.md << 'EOF'
        # VortexHash ${{ github.ref_name }} Release
        
        ## Summary
        This release provides the VortexHash cryptographic hash function with quantum-resistant security and high performance.
        
        ## Key Features
        - Quantum-resistant hash construction
        - Hardware acceleration support (SIMD, GPU)
        - Constant-time operations for side-channel resistance
        - Comprehensive benchmarking framework
        - Cross-platform compatibility
        
        ## Installation
        ```toml
        # DEBUG: Line 111-120: Checking indentation in TOML block
        [dependencies]
          vortex_hash = "${{ github.ref_name }}"
        
        [features]
          default = ["std"]
          simd = []
          hardware = []
          quantum = []
        # DEBUG: End of TOML block - indentation should align under keys
        ```
        
        ## Usage
        See README.md for complete documentation and examples.
        
        ## Security
        External cryptanalysis recommended before production use.
        Report issues to security@vortexhash.org
        EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            vortex_hash-${{ github.ref_name }}.tar.gz
            vortex_hash-docs-${{ github.ref_name }}.tar.gz
            vortex_hash-examples-${{ github.ref_name }}.tar.gz
          body_path: release-notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to crates.io
        if: startsWith(github.ref, 'v') && github.event_name == 'push'
        run: |
            cargo publish --token ${{ secrets.CRATES_IO_TOKEN }} --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}

      - name: Security notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          fields: repo,message,commit,author,action,eventName,